<!DOCTYPE html>
<html lang="en">
<head>
    <title lang="en">chou.ninja</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .block {
            display: block;
            width: 100%;
            border-width: medium;
            font-size: x-large;
            margin-bottom: inherit;
            background-color: gray;
            font-weight: bold;
            height: 5em;
            vertical-align: middle;
        }
        h1, .buttons, .answer, .mode {
            text-align: center;
        }
        .answer {
            font-size: xx-large;
        }
        .history, .answer {
            display: none;
        }
        body {
            color: white;
            background: black;
        }
        a {
            color: gray;
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      // See https://stackoverflow.com/a/2450976/3606378
      function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex;

        // While there remain elements to shuffle...
        while (0 !== currentIndex) {

          // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;

          // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }

        return array;
      }

      // See https://codeburst.io/understanding-memoization-in-3-minutes-2e58daf33a19
      function memoize(func){
        var cache = {};
        return function() {
          var key = JSON.stringify(arguments);
          if (cache[key]){
            return cache[key];
          }
          else{
            var val = func.apply(null, arguments);
            cache[key] = val;
            return val;
          }
        }
      }

      $(window).on('load', function() {
        main();
      });

      var numbers = [];
      for (var digit = 1; digit <= 10; digit++) {
        numbers.push(digit);
      }

      function main() {
        numbers.forEach(function (number) {
          var audio = number2audio(number);
          $("body").append(audio);
        })
        setupRandomButton();
      }

      var number2audio = memoize(function(number) {
        var source = $("<source />")
          .attr("src", "https://px0asnk62c.execute-api.ap-northeast-1.amazonaws.com/prod/day-of-month/" + number)
          .attr("type", "audio/mpeg");
        var audio = $("<audio />")
          .attr("id", "audio-day-of-the-month-" + number)
          .attr("preload", "none")
          .append(source);

        return audio;
      });

      var getNextNumber = (function() {
        var remainders = [];
        return function() {
          if (remainders.length == 0) {
            remainders = numbers.slice(0);
            remainders = shuffle(remainders);
          }
          var x = remainders.pop();
          return x;
        };
      })();

      function displayAnswer(number) {
        $(".answer").show();
        $(".answer > .suffix")
          .empty()
          .text(number2text(number));
      }

      function setupRandomButton() {
        $(".buttons > button")
          .mousedown(function() {
            var number = getNextNumber();
            play(number);
            displayAnswer(number);
            appendToHistory(number);
          });
      }

      function number2text(number) {
        return number + "日";
      }

      function appendToHistory(number) {
        var text = $("<span />")
          .text(number2text(number));
        var link = $("<a />")
          .attr("href", "javascript:void(0);")
          .text("[Hear again]")
          .mousedown(function() {
            play(number);
          });
        var record = $("<li />")
          .append(text, " ", link);
        $(".history").show();
        $(".history > ul").prepend(record);
      }

      var play = (function() {
        var dummyAudio = $("<audio />")[0];
        var prevAudio = dummyAudio;

        return function(number) {
          prevAudio.pause();
          prevAudio.currentTime = 0;

          var currAudio = number2audio(number)[0];
          currAudio.play();
          prevAudio = currAudio;
        };
      })();
    </script>
</head>
<body>

<h1 lang="ja">聴忍者</h1>

<div class="buttons">
    <button lang="en" class="block">
        Play random number
    </button>
</div>
<div class="answer">
    <span lang="en">
        Currently playing:
    </span>
    <span lang="ja" class="suffix"></span>
</div>

<hr />
<div class="mode">
    Mode: day of the month
</div>
<div class="history">
    <hr />
    <div>
        History:
    </div>
    <ul></ul>
</div>

<hr />
<div>
    <a href="http://jiashen.me">
        Home
    </a>
</div>
</body>
</html>
