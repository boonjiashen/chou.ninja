<!DOCTYPE html>
<html lang="en">
<head>
    <title lang="en">chou.ninja</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        button {
            display: block;
            width: 100%;
            border-width: medium;
            font-size: x-large;
            margin-bottom: inherit;
            /*background-color: rgb(80,80,80);*/
            font-weight: bold;
            height: 5em;
            vertical-align: middle;
            /*color: white;*/
        }
        h1, .buttons, .answer {
            text-align: center;
        }
        select {
            border-width: medium;
        }
        .answer {
            font-size: xx-large;
        }
        .history, .answer {
            display: none;
        }
        body {
            /*color: white;*/
            /*background: black;*/
        }
        a {
            /*color: darkgray;*/
        ;
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      // See https://stackoverflow.com/a/2450976/3606378
      function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex;

        // While there remain elements to shuffle...
        while (0 !== currentIndex) {

          // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;

          // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }

        return array;
      }

      // See https://codeburst.io/understanding-memoization-in-3-minutes-2e58daf33a19
      function memoize(func){
        var cache = {};
        return function() {
          var key = JSON.stringify(arguments);
          if (cache[key]){
            return cache[key];
          }
          else{
            var val = func.apply(null, arguments);
            cache[key] = val;
            return val;
          }
        }
      }

      // Expects a generator (function that takes no arguments), and calls it before the user calls
      function preload(func) {
        var nextReturn = func();
        return function() {
          var toBeReturned = nextReturn;
          nextReturn = func();
          return toBeReturned;
        }
      }

      $(window).on('load', function() {
        main();
      });

      var numbers = [];
      for (var digit = 1; digit <= 31; digit++) {
        numbers.push(digit);
      }

      var number2audio = memoize(function(number) {
        var source = $("<source />")
          .attr("src", "https://px0asnk62c.execute-api.ap-northeast-1.amazonaws.com/prod/day-of-month/" + number)
          .attr("type", "audio/mpeg");
        var audio = $("<audio />")
          .attr("id", "audio-day-of-the-month-" + number)
          .attr("preload", "auto")
          .append(source);
        $(".audios").append(audio);

        return audio;
      });

      function main() {
        $(".buttons > button")
          .mousedown(function() {
            var number = getNextNumberWithLookAhead();
            play(number);
            displayAnswer(number);
            appendToHistory(number);
          });
      }

      var getNextNumber = (function() {
        var remainders = [];
        return function() {
          if (remainders.length == 0) {
            remainders = numbers.slice(0);
            remainders = shuffle(remainders);
          }
          var x = remainders.pop();
          return x;
        };
      })();

      var getNextNumberWithLookAhead = preload(function() {
        var number = getNextNumber();
        number2audio(number);

        return number;
      });

      function displayAnswer(number) {
        $(".answer").show();
        $(".answer > .suffix")
          .empty()
          .text(number2text(number));
      }

      function number2text(number) {
        return number + "日";
      }

      function appendToHistory(number) {
        function getHistoryRecord(number) {
          var transcript = $("<span />")
            .text(number2text(number))
            .attr("lang", "ja");
          var anchor = $("<a />")
            .attr("href", "javascript:void(0);")
            .text("[Hear again]")
            .attr("lang", "en")
            .mousedown(function() {
              play(number);
            });
          var suffix = $("<span />")
            .append(anchor);

          return $("<li />")
            .append(transcript, " ", suffix);
        }

        $(".history").show();
        var historyRecord = getHistoryRecord(number);
        $(".history > ul").prepend(historyRecord);
      }

      var getCurrentPlaybackRate = (function() {
        var playbackRateNominal2Float = {
          "slow": 0.8,
          "normal": 1,
          "fast": 1.5
        };
        return function() {
          var nominalPlaybackRate = $(".playbackRate option:selected").val();
          return playbackRateNominal2Float[nominalPlaybackRate];
        };
      })();

      var play = (function() {
        var dummyAudio = $("<audio />")[0];
        var prevAudio = dummyAudio;

        return function(number) {
          prevAudio.pause();
          prevAudio.currentTime = 0;

          var currAudio = number2audio(number)[0];
          currAudio.playbackRate = getCurrentPlaybackRate();
          currAudio.play();
          prevAudio = currAudio;
        };
      })();
    </script>
</head>
<body>

<h1 lang="ja">聴忍者</h1>

<div class="audios"></div>

<div class="buttons">
    <button lang="en">
        Play random number
    </button>
</div>
<div class="answer">
    <span lang="en">
        Currently playing:
    </span>
    <span lang="ja" class="suffix"></span>
</div>

<hr />
<div class="setting" lang="en">
    <div>
        Playback content: day of the month
    </div>
    <div>
        Playback speed:
        <select class="playbackRate">
            <option value="fast">Fast</option>
            <option value="normal" selected>Normal</option>
            <option value="slow">Slow</option>
        </select>
    </div>
</div>

<div class="history">
    <hr />
    <div lang="en">
        History:
    </div>
    <ul></ul>
</div>

<hr />
<div lang="en">
    <a href="http://jiashen.me">
        Home
    </a>
</div>
</body>
</html>
