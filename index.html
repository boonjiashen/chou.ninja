<!DOCTYPE html>
<html lang="en">
<head>
    <title lang="en">chou.ninja</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .block {
            width: 30%;
            border-width: medium;
            font-size: x-large;
            margin-bottom: inherit;
            background-color: aliceblue;
            font-weight: bold;
            height: 5em;
            vertical-align: middle;
        }
        .answer {
            font-size: xx-large;
        }
        body {
            text-align: center;
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      $(window).on('load', function() {
        main();
      });

      // See https://stackoverflow.com/a/2450976/3606378
      function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex;

        // While there remain elements to shuffle...
        while (0 !== currentIndex) {

          // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;

          // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }

        return array;
      }

      // See https://codeburst.io/understanding-memoization-in-3-minutes-2e58daf33a19
      function memoize(func){
        var cache = {};
        return function() {
          var key = JSON.stringify(arguments);
          if (cache[key]){
            console.log(cache)
            return cache[key];
          }
          else{
            var val = func.apply(null, arguments);
            cache[key] = val;
            return val;
          }
        }
      }

      var numbers = [];
      for (var digit = 1; digit <= 10; digit++) {
        numbers.push(digit);
      }

      var number2audio = memoize(function(number) {
        var source = $("<source />")
          .attr("src", "https://px0asnk62c.execute-api.ap-northeast-1.amazonaws.com/prod/day-of-month/" + number)
          .attr("type", "audio/mpeg");
        var audio = $("<audio />")
          .attr("id", "audio-digit-" + number)
          .attr("preload", "none")
          .append(source);

        return audio;
      });

      var getNextNumber = (function() {
        var remainders = [];
        return function() {
          if (remainders.length == 0) {
            remainders = numbers.slice(0);
            remainders = shuffle(remainders);
          }
          var x = remainders.pop();
          return x;
        };
      })();

      function displayAnswer(number) {
        var prefix = $("<span />")
          .attr("lang", "en")
          .text("Currently playing: ");
        var suffix = $("<span />")
          .attr("lang", "ja")
          .text(number2text(number));
        $(".answer")
          .empty()
          .append(prefix, suffix);
      }

      function constructRandomButton() {
        var button = $("<button />")
          .attr("lang", "en")
          .addClass("block")
          .text("Play random number")
          .mousedown(function() {
            var number = getNextNumber();
            play(number);
            displayAnswer(number);
          });
          $(".buttons").append(button);
      }

      function number2text(number) {
        return number + "日";
      }

      function appendToHistory(number) {

      }

      function main() {
        numbers.forEach(function (number) {
          var audio = number2audio(number);
          $("body").append(audio);
        })
        constructRandomButton();
      }

      var play = (function() {
        var dummyAudio = $("<audio />")[0];
        var prevAudio = dummyAudio;

        return function(number) {
          prevAudio.pause();
          prevAudio.currentTime = 0;

          var currAudio = number2audio(number)[0];
          currAudio.play();
          prevAudio = currAudio;
        };
      })();
    </script>
</head>
<body>

<h1 lang="ja">聴忍者</h1>

<div class="buttons"></div>
<div class="answer"></div>
<div class="history"></div>

</body>
</html>
